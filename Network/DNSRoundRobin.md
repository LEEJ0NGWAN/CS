[돌아가기](./README.md)

# 라운드 로빈 DNS

별도의 소프트웨어 및 하드웨어 로드 밸런싱 장비를 이용하지 않고,

DNS를 통해 도메인 레코드 정보를 조회하는 시점에서 트래픽을 분산시키는 기법

→ Web, FTP, SMTP, TURN 등 다양한 환경에서 사용 가능

# 동작 원리

조회하고자 하는 어떤 요청 도메인 정보에 대해, 

여러 서버 IP 리스트 중 라운드 로빈 형태로 랜덤하게 하나 또는 여러개를 선발하여 사용자에게 반환

→ 결과적으로 사용자는 실제 복수의 서버에 걸쳐 분산되어 접속하므로 로드 밸런싱이 이루어짐

### 최근 변화

DNS 로빈 결과 1개의 IP 제공 → (순서가 있는) 여러 IP 리스트 제공하여 클라이언트가 선택

# 사용 시기

- 지리적(물리적)으로 서버들이 멀리 분산 되어 있을 때
- 실시간 헬스 체크가 어려울 때

    **헬스 체크** → 서버의 상태(오류 및 트래픽 정보 등)를 확인

- 비용 절감의 로드 밸런싱을 원할 때

# 특징

### ip 선발 로직

DNS 로빈 결과 IP 리스트에 대해, 사용자 OS 또는 애플리케이션에 따라 동작이 다를 수 있다

→ 제일 먼저 조회한 순서대로 ip를 사용할 수도 있고, 무작위로 ip를 선발하여 접속할 수도 있다

(선택한 ip에 접속 문제가 있다면, 다음 조회된 ip로 접속하는 로직을 추가할 수도 있음)

### 단순 로드 밸런싱

라운드 로빈 DNS는 가용성(HA)를 제공하지 않기 때문에, 무중단 서비스 시스템에 어울리지 않는다

→ 라운드 로빈 DNS는 단순 로드 밸런싱에 가성비가 좋은 옵션일 뿐이다

# DNS 조회 정보 캐싱

### Local DNS resolver 캐싱

조회된 IP 주소들은 사용자가 이용 중인 (ISP가 제공하는) 로컬 DNS resolver에 캐싱

### Client Application 캐싱

사용자 측에서 조회된 ip 주소에 대한 캐싱

### TTL (Time To Live)

TTL 동안 캐싱된 ip 주소를 해당 도메인 접속 주소로 사용

# TTL trade-off (캐싱 주기 설정)

- 캐싱 주기가 무조건 길다고 좋은 것이 아니다

    → DNS 정보를 바꿔도 인터넷 상으로 전파되는 시간이 오래걸림

- 캐싱 주기가 무조건 짧다고 좋은 것도 아니다

    → 빠른 업데이트가 가능하지만, 그만큼 도메인 조회가 많아지며 사용자 접속 시간에 영향을 끼침

# 단점

통상적인 로드 밸런싱의 헬스 체크가 불가능 하므로, 가용성(HA; High Availability) 용도로 적합하지 않다

→ 헬스 체크를 하지 않기 때문에, 특정 문제 있는 서버를 IP 리스트로 제공할 가능성이 생김

# 단점 보완 방법

- 헬쓰 체크가 포함된 DNS 서비스 이용 (AWS Route53, Dyn DNS ...)
- GSLB(Global Server Load Balancing) DNS 서비스 이용

    → 로드 밸런싱 + health check

    **로드 밸런서 SPOF(Single Point Of Failure)**

    로드 밸런서도 single point가 될 수 있기 때문에, 2대 이상의 로드 밸런서와 각각의 공인 ip 필요

    → GSLB로 트래픽을 여러대의 로드 밸런서에 분산 시키는 방법도 있음

# 단점 극복

응답이 없는 조회 결과를 배제 하도록 자체적인 헬쓰 체크 로직 구현

→ 그럼에도 캐싱 주기 만큼은 HA 구성이 어려운 단점이 남아있다

### 추세

A 레코드의 캐싱 주기를 매우 짧게 가져, 업데이트를 빠르게 하는 경향

# 세션 유지 관련

접속 중이던 클라이언트가 DNS 라운드 로빈으로 다른 서버 ip를 받아 접속한 경우

→ 기존 세션이 끊어질 우려가 있음

### 세션 유지 방법

- 세션 클러스터링

    서버끼리 세션을 공유할 수 있도록 설정

- Stickness

    로드 밸런서에 IP나 쿠키 값을 사용하여 동일 서버로 접속하도록 성정

    → L7 스위치로 해결 가능
